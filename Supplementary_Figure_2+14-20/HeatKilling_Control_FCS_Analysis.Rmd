---
title: "Vignette - Simple Flow"
author: "Julie Chuong"
date: "4/3/2022"
output:
  html_notebook: default
  pdf_document: default
  html_document: default
---
This notebook is to show you how to use the package CytoexploreR to analyze flow cytometry data from the Cytek Aurora. 
This vignette is worthwhile if you have only one or two flow datasets, like checking samples of GFP-tagged strains for GFP, viability stains of cells, etc. 
We do not recommend this vignette for timecourse data, ie. multiple subdirectories of flow data, wherein there is one subdirectory for each sampling day. 
For a vignette that analyzes timecourse flow data, see the our Vignette - Timecourse Flow.  


### Install CytoExplorer package and requirements. Skip if already installed.
```{r include = FALSE}
require("knitr")
knitr::opts_chunk$set(eval = FALSE, echo = TRUE, message = FALSE, warning = FALSE)
```

```{r}
library(BiocManager)
library(cowplot)
library(cytolib)
library(flowCore)
library(flowWorkspace)
library(openCyto)
library(devtools)
library(CytoExploreR)
library(tidyverse)
library(ggridges)
library(grid)
```

## Set working directory
Place your FCS files in a directory. Multiple subdirectories containing FCS files are OK. 

**Note 1**: You can only load in one folder's worth of FCS files at a time. In this vignette, 
we put all of our FCS data files in one subdirectory named FCS_files. There is one FSC file per sample.
In total, there are 4 FSC files. 

**Note 2**: You should **NOT** manually rename your FCS files after exporting it from the Cytek. 
In other words, files should have their original names from the machine. 
"Renaming the files manually is not recommended as it does not update the associated keywords contained in the FCS files"
(Source: https://github.com/DillonHammill/CytoExploreR/issues/85). If files need to renamed, do so on on the Cytek
software and re-export the FCS files.  

```{r setup, results='asis'}
require("knitr")
knitr::opts_knit$set(root.dir = "~/Documents/vignette_simple_data_workingcopy")
```

```{r include = TRUE}
getwd()
```

## Version name
Choose a name to be used for all output files including the gatingTemplate.csv and associated flow data and graphs.  
In this vignette, we will set it to my initials, date, and version 1. 
```{r}
version_name = "OzanImir_20250918_v2"
```

## STEP 1: Load in FCS data as a gating set  
  
  **INSTRUCTIONS**: 

+ An editable markers sheet will show up on `Viewer` Pane.
+ Edit Markers on Viewer pane by typing in "B2-A" in the `marker` column of the B2-A channel. FSC and SSC are included markers by default so you do not need to edit them.  
+ Scroll to the bottom of the Viewer pane.  
+ Click `Save & Close` button at the bottom of the `Viewer` pane.  

![](https://media.giphy.com/media/2G8UP1gfTSAIIqM8fG/giphy.gif)
```{r}
# We use B3-A. B12-A and YG4-A as our fluorescence channels
my_gating_set <- cyto_setup(path = "./FCS_files", restrict=TRUE, select="fcs")
```

## STEP 2: Edit the experimental details to include metadata from the sample sheet 
Merge samplesheet with autogenerated experiment details file generated from `cyto_setup()`.  
**ONLY NEED TO DO ONCE** to generate `Vignette-Experiment-Details.csv` file. Once you have the file, it will automatically be used the next time you load in FCS data as a gating set (STEP 1).

Here we assume the samplesheet metadata file is already in the working directory.   
Provide the file path to the sample sheet (metadata). 
```{r}
file.rename(dir(pattern = "Experiment-Details.csv"),"Vignette-Experiment-Details.csv")
exp_details = read_csv(file = paste0(list.files(pattern = "Experiment-Details.csv")))
sample_sheet = read_csv(file = paste0(list.files(pattern = "sample_sheet_vignette_simple.csv")))
experiment_details = left_join(exp_details, sample_sheet) %>%
  write_csv("Vignette-Experiment-Details.csv")
```
  
  Add the experiment details metadata to the gating set.  
  **ONLY NEED TO ONCE**
  
```{r}
# for(i in 1:length(names(experiment_details))){
#   flowWorkspace::pData(my_gating_set)[names(experiment_details[i])]<-experiment_details[i]
# }
```


Check that the experiment details metadata were successfully attached to the gating set.   
```{r}
cyto_details(my_gating_set)

```
By default the Experiment-Markers.csv file is named with the date created.  
Rename the autogenerated experiment-markers.csv file.  
**ONLY NEED TO DO ONCE**
```{r}
# file.rename(dir(pattern = "Experiment-Markers.csv"),"Vignette-Experiment-Markers.csv")
```  
## STEP 3:  Perform gating on gating set
Gate for 1) Cells, 2) Singlets, 3) CNVS  
Results in a gating file and gated data. 

**Transform the data**  
Transforming the data makes it easier to interpret visually and well as to draw gates.  
For this vignette's data, when the transformed data are plotted, the zero copy strains take up most of the coordinate plane and the one copy and two copy distributions are very close together. The fluorescence profiles/distributions of the one copy and two copy controls overlap some. They are not mutually exclusive which is a limitation to note. 

This is a useful article if you I want to think about choosing different transformations:
https://dillonhammill.github.io/CytoExploreR/articles/CytoExploreR-Transformations.html

In our case, it was necessary to use a logicle transformation for the `B2-A` values and then
a log transformation for the other values. I could not use `logicle transformation` nor could I use the `log transformation` for all values. 

**IMPORTANT**: If you get an error message*, run the in the Console, not inside the R notebook. Make sure you reset your working directory in the Console. 

*Error in plot.new() : QuartzBitmap_Output - unable to open file 

```{r}
SYTO9_trans <- cyto_transformer_arcsinh(my_gating_set, channels = c("B12-A"), cofactor = 150) #returns it as a list
PI_trans <- cyto_transformer_arcsinh(my_gating_set, channels = c("YG4-A"), cofactor = 150) #returns it as a list
FSC_SSC_trans <- cyto_transformer_arcsinh(my_gating_set, channels = c("FSC-A", "FSC-H", "SSC-A", "SSC-H"), cofactor = 500) #log transform the forward and side scatter
combined_trans <- cyto_transformer_combine(SYTO9_trans,PI_trans,FSC_SSC_trans) #combine both transformations
transformed_gating_set <- cyto_transform(my_gating_set, trans = combined_trans) #applies the the transformation and returns it as a gatingSet
```

Check the transformed data by plotting

```{r}
cyto_plot_explore(transformed_gating_set, #plots all FCS files
                  channels_x = "YG4-A",
                  channels_y = "B12-A",
                  axes_limits = "data")
```

Subset rows to plot as desired, using the row assignment in `cyto_details()`

```{r}
cyto_details(transformed_gating_set)

# Create two plots with cyto_plot_explore() from rows 1 and 2 to compare
cyto_plot_explore(transformed_gating_set[1,], #plots only rows 1 and 2
                  channels_x = "YG4-A",
                  channels_y = "B12-A",
                  axes_limits = "data")
cyto_plot_explore(transformed_gating_set[6,], #plots only rows 1 and 2
                  channels_x = "YG4-A",
                  channels_y = "B12-A",
                  axes_limits = "data")
```

### Draw Gates using Control Strains as a Guide

**Note**: if you already have a gating template and don't need to draw gates, skip the `cyto_gate_draw()` steps.  
Instead, use `cyto_gatingTemplate_apply()` to apply a `gatingTemplate.csv` to your gating set. 
```{r}
# cyto_gatingTemplate_apply(transformed_gating_set, gatingTemplate=paste0( "cytek_gating_",version_name,".csv"))
```


##### To Draw Gates

**INSTRUCTIONS**  

* A new window will pop out.  
* Draw the desired gate.  
* Press `esc` on keyboard when finished drawing to save the gate.  
* Gating coordinates will be placed in a gatingTemplate.csv file which can be applied (without drawing again) in future code runs.

First we gate for the cells, filtering out cell debris, bacteria, etc. 
```{r}
cyto_gate_draw(transformed_gating_set,
               parent = "root",
               alias = "Cells",
               channels = c("FSC-A","SSC-A"),
               axes_limits = "data",
               gatingTemplate = paste0("cytek_gating_",version_name,".csv")
)
```
![](https://media.giphy.com/media/ioVu7wNdo4TBRK0TPE/giphy.gif)
  
  
  Then we define the singlets based on side-scatter area and height.
See other ways to discriminate doublets: https://expert.cheekyscientist.com/how-to-perform-doublet-discrimination-in-flow-cytometry/ 
```{r}
cyto_gate_draw(transformed_gating_set,
               parent = "Cells",
               alias = "Single_cells",
               channels = c("SSC-A","SSC-H"),
               axes_limits = "data",
               gatingTemplate = paste0("cytek_gating_",version_name,".csv")
)
```
![](https://media.giphy.com/media/k79Tm14uZKsFUOpCW6/giphy.gif)

```{r}
cyto_details(transformed_gating_set) #View the rows and choose which to extract
```

We will gate for the cell viability ("Live_cells" and "Dead_cells") in the 2 dimensions that we have (PI and SYTO9).

```{r}
cyto_gate_draw(transformed_gating_set,
               parent = "Single_cells",
               alias = "Live_cells",
               channels = c("YG4-A","B12-A"),
               axes_limits = "data",
               gatingTemplate = paste0("cytek_gating_",version_name,".csv")
)

cyto_gate_draw(transformed_gating_set,
               parent = "Single_cells",
               alias = "Dead_cells",
               channels = c("YG4-A","B12-A"),
               axes_limits = "data",
               gatingTemplate = paste0("cytek_gating_",version_name,".csv")
)
```

# Plot out all the samples individually

```{r}
# Plot out all the samples individually (2x6 pages)
theme_set(theme_cowplot())
gs <- transformed_gating_set
rows_per_page <- 6L

# Helper: extract raw/inverse-transformed channels as data.frame for sample i
get_df <- function(gs, i, chans = c("YG4-A", "B12-A")) {
  cf <- gh_pop_get_data(gs[[i]], "root", inverse.transform = TRUE)
  ff <- cytoframe_to_flowFrame(cf)
  m <- exprs(ff)
  df <- as.data.frame(m[, chans, drop = FALSE], check.names = FALSE)
  names(df) <- chans
  df$PI <- df[[chans[1]]]
  df$SYTO9 <- df[[chans[2]]]
  df
}

# Helper: draw a log10 histogram when positive values exist, otherwise linear
plot_hist_log_if_positive <- function(df, var, xlabel) {
  x_max <- 1e6

  if (any(df[[var]] > 0, na.rm = TRUE)) {
    df_plot <- df[df[[var]] > 0 & is.finite(df[[var]]), , drop = FALSE]
    ggplot(df_plot, aes_string(var)) +
      geom_histogram(
        bins = 300,
        fill = "steelblue",
        color = "black",
        alpha = 0.6
      ) +
      scale_x_log10(limits = c(1, x_max)) +
      ggplot2::annotation_logticks(sides = "b") +
      coord_cartesian(xlim = c(1, x_max)) +
      labs(x = xlabel, y = "Count")
  } else {
    ggplot(df, aes_string(var)) +
      geom_histogram(
        bins = 300,
        fill = "steelblue",
        color = "black",
        alpha = 0.6
      ) +
      coord_cartesian(xlim = c(0, x_max)) +
      labs(x = xlabel, y = "Count")
  }
}

# Pagination
n_samples <- length(gs)
n_pages <- ceiling(n_samples / rows_per_page)

for (page in seq_len(n_pages)) {
  idx <- ((page - 1) * rows_per_page + 1):min(page * rows_per_page, n_samples)
  row_plots <- vector("list", length(idx))

  for (k in seq_along(idx)) {
    i <- idx[k]
    df <- get_df(gs, i, c("YG4-A", "B12-A"))

    p_pi <- plot_hist_log_if_positive(df, "PI", "PI")
    p_sy <- plot_hist_log_if_positive(df, "SYTO9", "SYTO9")

    row_core <- plot_grid(p_pi, p_sy, ncol = 2, align = "hv", axis = "tblr")

    # Label rows Aâ€“F per page
    row_plots[[k]] <- plot_grid(
      row_core,
      labels = paste0(LETTERS[k]),
      label_size = 18,
      label_fontface = "bold",
      label_x = 0,
      hjust = 0
    )
  }

  # Build the page grid (up to 6 rows) and save to its own PDF
  grid_2x6 <- plot_grid(plotlist = row_plots, ncol = 1)

  ggsave(
    filename = sprintf("plots/PI_SYTO9_grid_2x6_p%02d.pdf", page),
    plot = grid_2x6,
    device = grDevices::pdf,
    width = 10.5,
    height = 18,
    units = "in",
    useDingbats = FALSE
  )
}
```

## Create the gating quantified PI x SYTO9 plots for each sample

```{r}
# save_gating_png <- function(gs, samp, outfile) {
#   grDevices::png(filename = outfile, width = 6, height = 4, units = "in", res = 300)
#   on.exit(grDevices::dev.off(), add = TRUE)
# 
#   cyto_plot(
#     gs,
#     parent      = "Single_cells",
#     channels    = c("YG4-A", "B12-A"),
#     axes_limits = "data",
#     xlab        = "PI",
#     ylab        = "SYTO9",
#     alias = ""
#   )
# }
# 
# graphics.off()
# dir.create("plots", showWarnings = FALSE, recursive = TRUE)
# 
# for (i in seq_along(transformed_gating_set)) {
#   samp <- flowWorkspace::sampleNames(transformed_gating_set)[i]
#   outfile <- file.path("plots", sprintf("PI_SYTO9_gating_%s.png", samp))
#   try(save_gating_png(transformed_gating_set[i], samp, outfile), silent = TRUE)
# }
```
